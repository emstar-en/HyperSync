{
  "$id": "https://hypersync.dev/specs/sdl/sdl_query_receipt.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "additionalProperties": false,
  "description": "Receipt describing a semantic query against the SDL and the shards selected for use.",
  "properties": {
    "caller": {
      "additionalProperties": true,
      "description": "Information about the agent/capsule/task that initiated the query.",
      "properties": {
        "agent_id": {
          "type": "string"
        },
        "capsule_id": {
          "type": "string"
        },
        "task_id": {
          "type": "string"
        }
      },
      "type": "object"
    },
    "candidates": {
      "description": "All candidate shards returned by the SDL index for this query.",
      "items": {
        "additionalProperties": false,
        "properties": {
          "rank": {
            "description": "Rank of this candidate among all returned shards (1 = best).",
            "minimum": 1,
            "type": "integer"
          },
          "reason": {
            "description": "Optional explanation or classification of why this shard was returned.",
            "type": "string"
          },
          "score": {
            "description": "Similarity or relevance score assigned by the index.",
            "type": "number"
          },
          "shard_id": {
            "description": "Identifier of the shard (matches SDL shard descriptor id).",
            "type": "string"
          }
        },
        "required": [
          "shard_id",
          "score",
          "rank"
        ],
        "type": "object"
      },
      "type": "array"
    },
    "determinism_tier": {
      "description": "Determinism tier for SDL queries (expected to be D2).",
      "enum": [
        "D2_open_world"
      ],
      "type": "string"
    },
    "id": {
      "description": "Stable identifier for this SDL query receipt.",
      "type": "string"
    },
    "index_snapshot": {
      "additionalProperties": false,
      "properties": {
        "hash_value": {
          "description": "Optional hash/fingerprint of the index snapshot.",
          "type": "string"
        },
        "index_id": {
          "description": "Identifier for the SDL index instance used.",
          "type": "string"
        },
        "version": {
          "description": "Logical version or checkpoint identifier.",
          "type": "string"
        }
      },
      "required": [
        "index_id"
      ],
      "type": "object"
    },
    "metadata": {
      "additionalProperties": true,
      "description": "Free-form metadata for governance, observability, or debugging.",
      "type": "object"
    },
    "query": {
      "additionalProperties": false,
      "properties": {
        "embedding_space": {
          "description": "Embedding space used to represent this query, if applicable.",
          "type": "string"
        },
        "filters": {
          "additionalProperties": true,
          "description": "Structured filters applied alongside semantic similarity (e.g. tags, determinism_tier).",
          "type": "object"
        },
        "text": {
          "description": "Original text form of the semantic query.",
          "type": "string"
        }
      },
      "required": [
        "text"
      ],
      "type": "object"
    },
    "selected": {
      "description": "Subset of candidates actually selected for use by the caller.",
      "items": {
        "additionalProperties": false,
        "properties": {
          "reason": {
            "description": "Optional explanation of why this shard was selected.",
            "type": "string"
          },
          "shard_id": {
            "type": "string"
          }
        },
        "required": [
          "shard_id"
        ],
        "type": "object"
      },
      "type": "array"
    },
    "timestamp_utc": {
      "description": "Time at which the query was executed (UTC).",
      "format": "date-time",
      "type": "string"
    }
  },
  "required": [
    "id",
    "timestamp_utc",
    "query",
    "index_snapshot",
    "candidates"
  ],
  "title": "SDL Query Receipt",
  "type": "object"
}
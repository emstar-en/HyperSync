#!/bin/bash
# Bare Metal Deployment Script (Bash)
# Generated by STUNIR
# Module: {{ module_name }}
# Version: {{ version }}

set -e

echo "Starting deployment for {{ module_name }}..."

# 1. Prerequisites Check
echo "Checking prerequisites..."
{% for check in prerequisites %}
if ! command -v {{ check.command }} &> /dev/null; then
    echo "Error: {{ check.command }} is required but not installed."
    exit 1
fi
{% endfor %}

# 2. Environment Setup
echo "Setting up environment..."
export INSTALL_DIR="{{ install_dir | default('/opt/hypersync') }}"
mkdir -p "$INSTALL_DIR"

{% for var in env_vars %}
export {{ var.name }}="{{ var.default }}"
{% endfor %}

# 3. Download Artifacts
echo "Downloading artifacts..."
{% for artifact in artifacts %}
curl -L -o "$INSTALL_DIR/{{ artifact.name }}" "{{ artifact.url }}"
# Verify checksum
echo "{{ artifact.sha256 }}  $INSTALL_DIR/{{ artifact.name }}" | sha256sum -c -
{% endfor %}

# 4. Configuration
echo "Configuring service..."
cat <<EOF > "$INSTALL_DIR/config.toml"
{{ config_content }}
EOF

# 5. Service Installation (Systemd)
if [ -d "/etc/systemd/system" ]; then
    echo "Installing systemd service..."
    cat <<EOF > /etc/systemd/system/{{ service_name }}.service
[Unit]
Description={{ module_name }} Service
After=network.target

[Service]
User={{ service_user | default('root') }}
ExecStart=$INSTALL_DIR/{{ binary_name }} --config $INSTALL_DIR/config.toml
Restart=always

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable {{ service_name }}
    systemctl start {{ service_name }}
    echo "Service started."
else
    echo "Systemd not found. Starting manually..."
    nohup "$INSTALL_DIR/{{ binary_name }}" --config "$INSTALL_DIR/config.toml" &
    echo "Process started with PID $!"
fi

echo "Deployment complete!"

# IAM Bootstrap Policy Template
# This template generates the IAM bootstrap policy for a specific deployment environment.

id: "hypersync.core.iam_bootstrap.{{ environment }}"
kind: "bootstrap_policy"
policy:
  allow:
    - "create_ld"
    - "register_node"
    - "compute_route"
    - "catalog_models"
    - "compose_agent"
    - "status_summary"
  consent:
    default: "{{ consent_default | default('deny') }}"
    required_for:
      - "external_api_calls"
      - "data_sharing"
      - "telemetry_upload"
  deny:
    - "external_call_without_consent"
    - "file_system_write_outside_hypersync"
    - "network_call_without_approval"
    - "delete_domain_without_confirmation"
    - "modify_system_files"
  description: "Policy for Initialization Assistant Model operations in {{ environment }}"
  metadata:
    docs_first_run: "07_documentation/first_run_nvm_bootstrap.md"
    docs_iam: "07_documentation/human/reference/iam.md"
    hardware_profile_aware: true
    initialization_assistant_model: true
    environment: "{{ environment }}"
  name: "iam-policy-{{ environment }}"
  rules:
    - action: "create_ld"
      conditions:
        security_level:
          - "isolated"
          - "shared"
          - "public"
      rate_limit:
        max_per_minute: {{ rate_limits.create_ld | default(10) }}
    - action: "register_node"
      conditions:
        address_type:
          - "model"
          - "agent"
          - "service"
      rate_limit:
        max_per_minute: {{ rate_limits.register_node | default(60) }}
    - action: "compute_route"
      conditions: {}
      rate_limit:
        max_per_minute: {{ rate_limits.compute_route | default(60) }}
    - action: "catalog_models"
      conditions: {}
      rate_limit:
        max_per_minute: {{ rate_limits.catalog_models | default(10) }}
    - action: "compose_agent"
      conditions:
        max_members: {{ max_agent_members | default(10) }}
        min_members: 1
      rate_limit:
        max_per_minute: {{ rate_limits.compose_agent | default(10) }}
    - action: "status_summary"
      conditions: {}
      rate_limit:
        max_per_minute: {{ rate_limits.status_summary | default(30) }}
  telemetry:
    enabled: {{ telemetry_enabled | default('true') }}
    redact_pii: true
    retention_days: {{ telemetry_retention_days | default(30) }}
    store_locally: true

flow:
  states:
    - "DETECT_ENVIRONMENT"
    - "LOAD_OR_CREATE_HARDWARE_PROFILE"
    - "INITIALIZE_CORE_NVM_BLOCKS"
    - "SDL_DISCOVERY"
    - "VNES_SELECTION"
    - "BOOTSTRAP_DIALOG"
    - "APPLY_PROFILE_AND_INITIALIZE"
    - "EMIT_BOOTSTRAP_RECEIPTS"
    - "READY_FOR_USER"
  requirements:
    hardware_profile: "required"
    sdl_connectivity: "{{ sdl_connectivity | default('optional') }}"
    vnes_catalog: "required"

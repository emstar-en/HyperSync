{
  "$id": "https://hypersync.io/schemas/token/token_event_v1.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "description": "Schema for token usage events in the prompt pipeline",
  "properties": {
    "compression_ratio": {
      "description": "Compression ratio (tokens_out / tokens_in)",
      "maximum": 1,
      "minimum": 0,
      "type": "number"
    },
    "event_id": {
      "description": "Unique event identifier",
      "pattern": "^tok_[a-zA-Z0-9]{16}$",
      "type": "string"
    },
    "metadata": {
      "description": "Additional stage-specific metadata",
      "properties": {
        "cost_usd": {
          "description": "Estimated cost in USD",
          "type": "number"
        },
        "error": {
          "description": "Error message if stage failed",
          "type": "string"
        },
        "latency_ms": {
          "description": "Stage processing latency in milliseconds",
          "type": "integer"
        },
        "technique": {
          "description": "Compression or processing technique used",
          "type": "string"
        }
      },
      "type": "object"
    },
    "model": {
      "description": "Model used for token counting or processing",
      "type": "string"
    },
    "provider": {
      "description": "Provider identifier (e.g., 'chatllm', 'openai')",
      "type": "string"
    },
    "request_id": {
      "description": "Associated request/prompt ID",
      "type": "string"
    },
    "session_id": {
      "description": "Session identifier for aggregation",
      "type": "string"
    },
    "stage": {
      "description": "Pipeline stage that generated the event",
      "enum": [
        "input",
        "preprocessing",
        "summarization",
        "hyperbolic_compression",
        "diff_generation",
        "provider_request",
        "provider_response",
        "postprocessing",
        "output"
      ],
      "type": "string"
    },
    "timestamp": {
      "description": "Event timestamp in ISO 8601 format",
      "format": "date-time",
      "type": "string"
    },
    "tokens_in": {
      "description": "Number of tokens entering the stage",
      "minimum": 0,
      "type": "integer"
    },
    "tokens_out": {
      "description": "Number of tokens exiting the stage",
      "minimum": 0,
      "type": "integer"
    },
    "tokens_saved": {
      "description": "Number of tokens saved by this stage (tokens_in - tokens_out)",
      "minimum": 0,
      "type": "integer"
    },
    "user_id": {
      "description": "User identifier for quota tracking",
      "type": "string"
    }
  },
  "required": [
    "event_id",
    "timestamp",
    "stage",
    "tokens_in",
    "tokens_out"
  ],
  "title": "Token Event",
  "type": "object"
}
{
  "$id": "https://hypersync.io/schemas/receipts/token_usage_v1.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "description": "Comprehensive receipt for token usage across pipeline stages",
  "properties": {
    "metadata": {
      "description": "Additional metadata",
      "type": "object"
    },
    "provider": {
      "description": "Provider-specific details",
      "properties": {
        "completion_tokens": {
          "type": "integer"
        },
        "cost_usd": {
          "type": "number"
        },
        "model": {
          "type": "string"
        },
        "prompt_tokens": {
          "type": "integer"
        },
        "provider_id": {
          "type": "string"
        }
      },
      "type": "object"
    },
    "receipt_id": {
      "description": "Unique receipt identifier",
      "pattern": "^rcpt_[a-zA-Z0-9]{16}$",
      "type": "string"
    },
    "request_id": {
      "description": "Associated request identifier",
      "type": "string"
    },
    "savings": {
      "description": "Savings analysis",
      "properties": {
        "actual_tokens": {
          "description": "Tokens with compression",
          "type": "integer"
        },
        "baseline_tokens": {
          "description": "Tokens without compression",
          "type": "integer"
        },
        "cost_saved_usd": {
          "description": "Estimated cost savings",
          "type": "number"
        },
        "savings_percent": {
          "description": "Percentage saved",
          "type": "number"
        },
        "tokens_saved": {
          "description": "Difference",
          "type": "integer"
        }
      },
      "type": "object"
    },
    "session_id": {
      "description": "Session identifier",
      "type": "string"
    },
    "stages": {
      "description": "Per-stage token accounting",
      "items": {
        "properties": {
          "compression_ratio": {
            "maximum": 1,
            "minimum": 0,
            "type": "number"
          },
          "latency_ms": {
            "minimum": 0,
            "type": "integer"
          },
          "stage": {
            "description": "Stage name",
            "type": "string"
          },
          "tokens_in": {
            "minimum": 0,
            "type": "integer"
          },
          "tokens_out": {
            "minimum": 0,
            "type": "integer"
          },
          "tokens_saved": {
            "minimum": 0,
            "type": "integer"
          }
        },
        "required": [
          "stage",
          "tokens_in",
          "tokens_out"
        ],
        "type": "object"
      },
      "type": "array"
    },
    "timestamp": {
      "description": "Receipt generation timestamp",
      "format": "date-time",
      "type": "string"
    },
    "total_tokens": {
      "description": "Total token counts across all stages",
      "properties": {
        "input": {
          "description": "Total input tokens",
          "minimum": 0,
          "type": "integer"
        },
        "output": {
          "description": "Total output tokens",
          "minimum": 0,
          "type": "integer"
        },
        "provider_charged": {
          "description": "Tokens actually charged by provider",
          "minimum": 0,
          "type": "integer"
        },
        "saved": {
          "description": "Total tokens saved by compression",
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "input",
        "output",
        "saved"
      ],
      "type": "object"
    },
    "user_id": {
      "description": "User identifier",
      "type": "string"
    }
  },
  "required": [
    "receipt_id",
    "timestamp",
    "request_id",
    "total_tokens",
    "stages"
  ],
  "title": "Token Usage Receipt",
  "type": "object"
}
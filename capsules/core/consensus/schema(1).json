{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "HyperSync Core Consensus Capsule API Schema (Enhanced)",
  "type": "object",
  "definitions": {
    "EnvironmentId": {
      "type": "string",
      "description": "Identifier for an environment (tenant, session, or global)."
    },
    "ProposalId": {
      "type": "string",
      "description": "Identifier for a consensus proposal."
    },
    "DecisionId": {
      "type": "string",
      "description": "Identifier for a consensus decision."
    },
    "ConsensusOperation": {
      "type": "string",
      "enum": [
        "Propose",
        "Vote",
        "Decide",
        "GetView",
        "ListDecisions",
        "Subscribe"
      ]
    },
    "ProposalPayloadRef": {
      "type": "object",
      "properties": {
        "schema_id": {
          "type": "string",
          "description": "Identifier of the schema for the proposal payload."
        },
        "hash": {
          "type": "string",
          "description": "Hash of the serialized proposal payload."
        }
      },
      "required": ["schema_id", "hash"],
      "additionalProperties": false
    },
    "VoteValue": {
      "type": "string",
      "enum": ["accept", "reject", "abstain"]
    },
    "VoteRecord": {
      "type": "object",
      "properties": {
        "voter_id": {
          "type": "string",
          "description": "Identifier of the voting participant."
        },
        "vote": {
          "$ref": "#/definitions/VoteValue"
        },
        "reason": {
          "type": "string",
          "description": "Human- or machine-readable rationale for the vote."
        }
      },
      "required": ["voter_id", "vote"],
      "additionalProperties": false
    },
    "ConsensusRequest": {
      "type": "object",
      "properties": {
        "operation": {
          "$ref": "#/definitions/ConsensusOperation"
        },
        "environment_id": {
          "$ref": "#/definitions/EnvironmentId"
        },
        "proposal_id": {
          "$ref": "#/definitions/ProposalId"
        },
        "decision_id": {
          "$ref": "#/definitions/DecisionId"
        },
        "payload_ref": {
          "$ref": "#/definitions/ProposalPayloadRef"
        },
        "vote": {
          "$ref": "#/definitions/VoteRecord"
        },
        "constraints": {
          "type": "object",
          "description": "Determinism, quorum, or policy constraints for this operation."
        },
        "trace_id": {
          "type": "string",
          "description": "Trace identifier for receipts and telemetry correlation."
        }
      },
      "required": ["operation"],
      "additionalProperties": false
    },
    "ConsensusResponse": {
      "type": "object",
      "properties": {
        "ok": {
          "type": "boolean"
        },
        "result": {
          "type": "object",
          "description": "Operation-specific result object (e.g., proposal handle, decision, view)."
        },
        "error": {
          "type": ["null", "object"],
          "description": "Error object if ok = false."
        },
        "meta": {
          "type": "object",
          "description": "Metadata including determinism tier, quorum details, and capsule identity."
        }
      },
      "required": ["ok"],
      "additionalProperties": false
    }
  },
  "properties": {
    "request": {
      "$ref": "#/definitions/ConsensusRequest"
    },
    "response": {
      "$ref": "#/definitions/ConsensusResponse"
    }
  },
  "additionalProperties": false
}

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "HyperSync Bridge API Schema (Enhanced)",
  "type": "object",
  "definitions": {
    "BridgeErrorCode": {
      "type": "string",
      "enum": [
        "OK",
        "BAD_REQUEST",
        "UNAUTHORIZED",
        "FORBIDDEN",
        "NOT_FOUND",
        "RATE_LIMITED",
        "INTERNAL_ERROR",
        "BACKEND_UNAVAILABLE",
        "SCHEMA_VALIDATION_FAILED"
      ]
    },
    "UserContext": {
      "type": "object",
      "properties": {
        "user_id": {
          "type": "string"
        },
        "tenant_id": {
          "type": "string"
        },
        "session_id": {
          "type": "string"
        },
        "roles": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "client_type": {
          "type": "string",
          "enum": [
            "TUI",
            "SERVICE",
            "BROWSER",
            "CLI",
            "OTHER"
          ]
        },
        "ip_hash": {
          "type": "string"
        }
      },
      "required": [
        "user_id"
      ],
      "additionalProperties": false
    },
    "VirtualEnvironmentRef": {
      "type": "object",
      "properties": {
        "environment_id": {
          "type": "string"
        },
        "tenant_id": {
          "type": "string"
        },
        "shard_id": {
          "type": "string"
        },
        "region": {
          "type": "string"
        },
        "kind": {
          "type": "string",
          "description": "e.g., simulation, diagnostic, replay"
        }
      },
      "required": [
        "environment_id"
      ],
      "additionalProperties": false
    },
    "RateLimitInfo": {
      "type": "object",
      "properties": {
        "limit": {
          "type": "integer"
        },
        "remaining": {
          "type": "integer"
        },
        "reset_at": {
          "type": "integer",
          "description": "Unix timestamp (ms)"
        }
      },
      "required": [
        "limit",
        "remaining",
        "reset_at"
      ],
      "additionalProperties": false
    },
    "BridgeRequestEnvelope": {
      "type": "object",
      "properties": {
        "version": {
          "type": "string",
          "default": "v1"
        },
        "trace_id": {
          "type": "string"
        },
        "correlation_id": {
          "type": "string"
        },
        "user": {
          "$ref": "#/definitions/UserContext"
        },
        "target_env": {
          "$ref": "#/definitions/VirtualEnvironmentRef"
        },
        "target_agent_id": {
          "type": "string"
        },
        "operation": {
          "type": "string",
          "description": "Logical operation name (e.g., environment.create, agent.command)."
        },
        "payload": {
          "type": "object"
        },
        "schema_id": {
          "type": "string",
          "description": "Schema ID describing payload shape."
        },
        "timestamp": {
          "type": "integer",
          "description": "Unix timestamp (ms)."
        },
        "idempotency_key": {
          "type": "string"
        }
      },
      "required": [
        "version",
        "trace_id",
        "user",
        "operation",
        "payload"
      ],
      "additionalProperties": false
    },
    "BridgeResponseEnvelope": {
      "type": "object",
      "properties": {
        "version": {
          "type": "string",
          "default": "v1"
        },
        "trace_id": {
          "type": "string"
        },
        "correlation_id": {
          "type": "string"
        },
        "success": {
          "type": "boolean"
        },
        "error_code": {
          "$ref": "#/definitions/BridgeErrorCode"
        },
        "error_message": {
          "type": "string"
        },
        "data": {
          "type": "object"
        },
        "timestamp": {
          "type": "integer"
        },
        "rate_limit": {
          "$ref": "#/definitions/RateLimitInfo"
        }
      },
      "required": [
        "version",
        "trace_id",
        "success"
      ],
      "additionalProperties": false
    },
    "WsClientMessageType": {
      "type": "string",
      "enum": [
        "SUBSCRIBE",
        "UNSUBSCRIBE",
        "ACTION",
        "PING"
      ]
    },
    "WsServerMessageType": {
      "type": "string",
      "enum": [
        "UPDATE",
        "ERROR",
        "ACK",
        "HEARTBEAT",
        "RATE_LIMIT_NOTICE"
      ]
    },
    "WsClientMessage": {
      "type": "object",
      "properties": {
        "type": {
          "$ref": "#/definitions/WsClientMessageType"
        },
        "channel": {
          "type": "string"
        },
        "payload": {
          "type": "object"
        },
        "correlation_id": {
          "type": "string"
        },
        "timestamp": {
          "type": "integer"
        }
      },
      "required": [
        "type",
        "payload"
      ],
      "additionalProperties": false
    },
    "WsServerMessage": {
      "type": "object",
      "properties": {
        "type": {
          "$ref": "#/definitions/WsServerMessageType"
        },
        "channel": {
          "type": "string"
        },
        "payload": {
          "type": "object"
        },
        "correlation_id": {
          "type": "string"
        },
        "timestamp": {
          "type": "integer"
        },
        "trace_id": {
          "type": "string"
        },
        "rate_limit": {
          "$ref": "#/definitions/RateLimitInfo"
        }
      },
      "required": [
        "type",
        "payload"
      ],
      "additionalProperties": false
    },
    "ApiResponse": {
      "type": "object",
      "properties": {
        "success": {
          "type": "boolean"
        },
        "data": {
          "type": "object"
        },
        "error": {
          "type": "string"
        },
        "trace_id": {
          "type": "string"
        }
      },
      "required": [
        "success",
        "trace_id"
      ],
      "additionalProperties": true,
      "description": "Legacy ApiResponse for backward compatibility. Prefer BridgeResponseEnvelope."
    },
    "WebSocketMessage": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "SUBSCRIBE",
            "UNSUBSCRIBE",
            "ACTION",
            "UPDATE",
            "ERROR"
          ]
        },
        "channel": {
          "type": "string"
        },
        "payload": {
          "type": "object"
        },
        "timestamp": {
          "type": "integer"
        }
      },
      "required": [
        "type",
        "payload"
      ],
      "additionalProperties": true,
      "description": "Legacy WebSocketMessage for backward compatibility. Prefer WsClientMessage/WsServerMessage."
    }
  },
  "properties": {
    "rest_request": {
      "$ref": "#/definitions/BridgeRequestEnvelope"
    },
    "rest_response": {
      "$ref": "#/definitions/BridgeResponseEnvelope"
    },
    "ws_client_message": {
      "$ref": "#/definitions/WsClientMessage"
    },
    "ws_server_message": {
      "$ref": "#/definitions/WsServerMessage"
    },
    "legacy_rest_response": {
      "$ref": "#/definitions/ApiResponse"
    },
    "legacy_ws_message": {
      "$ref": "#/definitions/WebSocketMessage"
    }
  },
  "additionalProperties": false
}